<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">

     
    <title>HELIO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/assests/css/chekout.css">
</head>
 
<body>
    <div class="navigation">
        <div class="nav-center container d-flex">
            <a href="/" class="logo">
                <h1 style="font-weight: bold;">HELIO</h1>
            </a>

            <ul class="nav-list d-flex">
                <!-- <li class="nav-item">
                    <a href="/" class="nav-link">Home</a>
                </li>
                <li class="nav-item">
                    <a href="/prod" class="nav-link">Shop</a>
                </li>
                <li class="nav-item">
                    <a href="#terms" class="nav-link">Terms</a>
                </li>
                <li class="nav-item">
                    <a href="#about" class="nav-link">About</a>
                </li>
                <li class="nav-item">
                    <a href="#contact" class="nav-link">Contact</a>
                </li>
                <li class="icons d-flex">
                    <a href="/profile" class="icon">
                        <i class="bx bx-user"></i>
                    </a>
                    <div class="icon">
                        <i class="bx bx-search"></i>
                    </div>
                    <div class="icon">
                        <i class="bx bx-heart"></i>
                        <span class="d-flex">0</span>
                    </div>
                    <a href="cart.html" class="icon">
                        <i class="bx bx-cart"></i>
                        <span class="d-flex">0</span>
                    </a>

                </li> -->
            </ul>






            <div class="hamburger">
                <i class="bx bx-menu-alt-left"></i>
            </div>
        </div>
    </div>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/5.3.45/css/materialdesignicons.css"
        integrity="sha256-NAxhqDvtY0l4xn+YVa6WjAcmd94NNfttjNsDmNatFVc=" crossorigin="anonymous" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <div class="container">
        <div class="row">
            <div class="col-xl-8">
                <div class="card">
                    <div class="card-body">
                        <ol class="activity-checkout mb-0 px-4 mt-3">
                            <li class="checkout-item">
                                <!-- <div class="avatar checkout-icon p-1">
                                    <div class="avatar-title rounded-circle bg-primary">
                                        <i class="bx bxs-receipt text-white font-size-20"></i>
                                    </div>
                                </div> -->
                                <div class="feed-item-list">
                                    <div>
                                        <h5 class="font-size-16 mb-1">Shipping Info</h5><a href="/addaddress" ><button class="address11">New Address</button></a>
                                        
                                        <p class="text-muted text-truncate mb-4"></p>
                                        <div class="mb-3" id="address">
                                            <div class="row">
                                                <% if (address.length === 0) { %>
                                                    <div class="col-12">
                                                        <div id="errorMessage" style="color: rgb(0, 0, 0);">No addresses available</div>
                                                    </div>
                                                <% } else { %>
                                                    <% address.forEach((item, index) => { %>
                                                        <div class="col-lg-4 col-sm-6">
                                                            <div>
                                                                <label class="card-radio-label mb-0">
                                                                    <input type="radio" name="address" id="info-address-<%= index %>" value="<%= item._id %>" class="card-radio-input">
                                                                    <div class="card-radio text-truncate p-3">
                                                                        <span class="fs-14 mb-2 d-block"> <%= item.name %></span>
                                                                        <span class="text-muted fw-normal text-wrap mb-1 d-block">
                                                                            Address: <%= item.address %>, <%= item.locality %>, <%= item.district %>, <%= item.state %> - <%= item.pincode %>
                                                                        </span>
                                                                        <span class="text-muted fw-normal d-block">Mo. <%= item.mobileNumber %></span>
                                                                        <a href='/updateAddress/<%= item._id %>' data-bs-toggle="tooltip" data-placement="top" title="Edit">
                                                                            <i class="bx bx-pencil font-size-16"></i>
                                                                        </a>
                                                                        
                                                                    </div>
                                                                </label>
                                                            </div>
                                                        </div>
                                                    <% }) %>
                                                    <div id="errorMessage" style="color: red;"></div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li class="checkout-item">
                                <!-- <div class="avatar checkout-icon p-1">
                                    <div class="avatar-title rounded-circle bg-primary">
                                        <i class="bx bxs-truck text-white font-size-20"></i>
                                    </div>
                                </div> -->
                               
                            </li>
                            <li class="checkout-item">
                                <div class="avatar checkout-icon p-1">
                                    <div class="avatar-title rounded-circle bg-primary">
                                        <i class="bx bxs-wallet-alt text-white font-size-20"></i>
                                    </div>
                                </div>
                                <div class="feed-item-list">
                                    
                                   
                                    <div>
                                        
                                        <h5 class="font-size-14 mb-3">Payment method :</h5>
                                        
                                        <div class="row">
                                           
                                            <div class="col-lg-3 col-sm-6">
                                                <div data-bs-toggle="collapse">
                                                    <label class="card-radio-label">
                                                        <input type="radio" name="pay" value="wallet" id="pay-methodoption1"
                                                            class="card-radio-input">
                                                        <span class="card-radio py-3 text-center text-truncate">
                                                            <i class="bx bx-credit-card d-block h2 mb-3"></i>
                                                            wallet
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-sm-6">
                                                <div>
                                                    <label class="card-radio-label">
                                                        <input type="radio" name="pay" value="online" id="pay-methodoption2"
                                                            class="card-radio-input">
                                                        <span class="card-radio py-3 text-center text-truncate">
                                                            <i class="bx bxl-paypal d-block h2 mb-3"></i>
                                                            Online
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-sm-6">
                                                <div>
                                                    <label class="card-radio-label">
                                                        <input type="radio" name="pay" value="cod" id="pay-methodoption3"
                                                            class="card-radio-input" checked>
                                                        <span class="card-radio py-3 text-center text-truncate">
                                                            <i class="bx bx-money d-block h2 mb-3"></i>
                                                            <span>Cash on Delivery</span>
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="text-end mt-2 mt-sm-0">
                                                <button class="btn btn-warning apply-button" data-toggle="modal" data-target="#couponModal">Apply coupon</button>
                                             <button class="btn btn-success" id="placeOrder">
                                                    <i class="mdi mdi-cart-outline me-1"></i> Procced </button>  
                                                    
                                            </div>
                                            
                                            
                                        </div>
                                   
                                    </div>
                              
                                </div>
                            </li>
                        </ol>
                    </div>
                </div>
                <div class="row my-4">
                    
                    <div class="col">
                        
                    </div>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="card checkout-order-summary">
                    <div class="card-body">
                        <div class="p-3 bg-light mb-3">
                            <h5 class="font-size-16 mb-0">Order Summary <span class="float-end ms-2"></span></h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-centered mb-0 table-nowrap">
                                <thead>
                                    <tr class="">
                                        <th class="border-top-0 text-black" style="width: 110px;" scope="col"></th>
                                        <th class="border-top-0 text-black" scope="col"></th>
                                        <th class="border-top-0 text-black" scope="col"></th>
                                    </tr>
                                </thead>
                                <tbody id="orderItems">
                                 <%   if(!products||products.items.length==0){ %>
                                         
                                   <% }else{ %>
    <% products.items.forEach(item => { %>
    <tr class="order-item" data-product-id="<%= item.productId._id %>" data-quantity="<%= item.quantity %>">
        <th scope="row">
            <!-- <img src="<%= item.productId.images[0] %>" alt="product-img" title="product-img" class="avatar-lg rounded"> -->
        </th>
        <td>
            <!-- <h5 class="font-size-16 text-truncate"><a href="#" class="text-dark"><%= item.productId.brand %></a></h5> -->
            <!-- <p class="text-muted mb-0">
                <i class="bx bxs-star text-warning"></i>
                <i class="bx bxs-star text-warning"></i>
                <i class="bx bxs-star text-warning"></i>
                <i class="bx bxs-star text-warning"></i>
                <i class="bx bxs-star-half text-warning"></i>
            </p> -->
           
           
        </td>
        <!-- <td>&#8377 <%= item.productId.price %></td> -->
    </tr>
    <% }) %>
    <tr>
        <td colspan="2">
            <h5 class="font-size-14 m-0">Sub Total :</h5>
        </td>
        <td>
            <%= products.totalAmount %>
        </td>
    </tr>
    <tr>
        <td colspan="2">
            <h5 class="font-size-14 m-0">Shipping Charge :</h5>
        </td>
        <% if(products.totalAmount>'1000'){ %>
        <td>Free</td>
        <% }else{ %>
            <td>50</td>
            <% } %>
    </tr>
    <tr>
        <td colspan="2">
            <h5 class="font-size-14 m-0">Coupon Discount:</h5>
        </td>
        <td id="dicount-coupon">0</td>
    </tr>
    <tr class="bg-light">
        <td colspan="2">
            <h5 class="font-size-14 m-0">Total:</h5>
        </td>
        <% console.log("balaceeeeee",products.totalAmount) %>
        <% if(products.totalAmount>'1000'){ %>
        <td id="totalAmountid"><%= products.totalAmount %></td>
        <% }else{ %> 
            <td id="totalAmountid"> <%= products.totalAmount+50 %></td>
            <% } %>
    </tr>
</tbody>
<%}%>
                            </table>
                        </div>
                    </div>
                </div>
                <p id="outofstock"></p>
            </div>
            
        </div>
  </div>
 
    <footer class="footer col-12">
        <div class="row">
            <div class="col ">
                <h4>INFORMATION</h4>
                <a href="">About us</a>
                <a href="">Contact Us</a>
                <a href="">Term & Conditions</a>
                <a href="">Shipping Guide</a>
            </div>
            <div class="col d-flex">
                <h4>USEFUL LINK</h4>
                <a href="">Online Store</a>
                <a href="">Customer Services</a>
                <a href="">Promotion</a>
                <a href="">Top Brands</a>
            </div>
            <div class="col d-flex">
                <span><i class="bx bxl-facebook-square"></i></span>
                <span><i class="bx bxl-instagram-alt"></i></span>
                <span><i class="bx bxl-github"></i></span>
                <span><i class="bx bxl-twitter"></i></span>
                <span><i class="bx bxl-pinterest"></i></span>
            </div>
        </div>
    </footer>


    <!-- Modal -->
	<div class="modal fade" id="couponModal" tabindex="-1" role="dialog" aria-labelledby="couponModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <% if (applicableCoupons && applicableCoupons.length> 0) { %>
                    <h2>Available Coupons</h2>
                    <ul>
                        <% applicableCoupons.forEach((coupon, index)=> { %>

                            <li>

                                <input type="radio" name="couponS" id="coupon_<%= index%>"
                                    value="<%=coupon.couponcode%>">
                                <input type="text" value="<%=coupon?.couponcode%>" hidden id="couponId">
                                <label for="coupon_<%= index %>">
                                    <b>Code:</b>
                                    <%= coupon.couponcode %> (Expires: <%= coupon.expireDate.toLocaleDateString() %>
                                            )<br>
                                            <b>discountPercentage:</b>
                                            <%= coupon.discountPercentage %>
                                </label>
                            </li>
                            <% }); %>
                    </ul>
                    <% } else { %>
                        <p>No applicable coupons found.</p>
                        <% } %>
                            <input type="hidden" id="isCouponApplied" value="false">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="applySelectedCoupon">Apply Selected
                    Coupon</button>
            </div>
        </div>
    </div>
</div>
            
            
        </div>
    </div>
</div>

    <!-- Custom Script -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/assests/js/index.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Include Toastr CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Include Toastr JS -->

    <script>
     document.getElementById("placeOrder").addEventListener("click", () => {
       
        const items = [];
			document.querySelectorAll('#orderItems .order-item').forEach(item => {
				const productId = item.dataset.productId;
				const quantity = item.dataset.quantity;
            
               
				items.push({ productId, quantity });
			});
            const errorMessageElement = document.getElementById('errorMessage');
            const selectedAddressElement = document.querySelector('#address input[name="address"]:checked');
            if (!selectedAddressElement) {
                errorMessageElement.innerHTML = 'Please select an address';
                return;
            }
            
            const selectedAddress= document.querySelector('#address input[name="address"]:checked').value;
            
            
           
          
            const paymentMethod = document.querySelector('input[name="pay"]:checked').value;
            console.log('paymentMethod',paymentMethod);
            fetch("/verifyStock", {
				method: "POST",
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ allItems: items })
			}).then(res => res.json())
				.then(res => {
                    
                    let a=0
					res.outOfStockItems.forEach(item => {
                       a++
						
					})
                    if(a!=0){
                        document.getElementById('outofstock').innerHTML='some product are out of stock'
                    }
					
					if (res.outOfStockItems.length === 0) {
                       
                            const data = {
							items: items,
							addressId: selectedAddress,
                          
						}
                        
                           
                        if (paymentMethod === 'cod' && items.length != 0) {
                            var totalElement = document.getElementById('totalAmountid');
                            var couponelement = document.getElementById('dicount-coupon');

                                const totalamount = totalElement.textContent.trim();
                                const coupondiscount = couponelement.textContent.trim();


                                   if(totalamount>100000){
                                    Swal.fire({ 
										title: "Failed!",
										text:  "Cash not delivery allowed above 1000000",
										icon: "error",
									});
                                   }else{

                           
                            fetch("/stockresult", {
								method: 'post',
								headers: {
									'content-Type': 'application/json'
								},
								body: JSON.stringify({ data, paymentMethod,totalamount})
                            
							})
                            
                            .then(res => res.json())
                                    .then(res => { 
                                        
                                        if (res.status === 401) {
                                            
                                            toastr.error('Please add the Address to checkout');
                                        }
                                        
                                        if (res.message === 'order completed') {
                                            window.location.href = '/thankyou'
                                        }
                                    })

						}}
                        
                             if(paymentMethod === 'online' && items.length != 0){
                                
                                var totalElement = document.getElementById('totalAmountid');
                                const totalamount = totalElement.textContent.trim();
                                
                            
                                
                                fetch('/razorpayment', {
								method: 'post',
								headers: {
									'content-Type': 'application/json'
								},
								body: JSON.stringify({ totalamount,coupondiscount })
							}).then(res => res.json())
                            .then(res => {
                                const options = {
                                            "key": "rzp_test_iAqbez4gZElsL0",
                                            "amount": res.order.amount,
                                            "currency": "INR",
                                            "name": 'HELIO', 
                                            "description": "Test Transaction",
                                            "image": "",
                                            "order_id": res.order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                                            "callback_url": `/onlinepayment?paymentMethod=${paymentMethod}&data=${JSON.stringify(data)}&total=${totalamount}`,
                                            "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information especially their phone number
                                                // "name": "Gaurav Kumar", //your customer's name
                                                // "email": "",
                                                // "contact": "" //Provide the customer's phone number for better conversion rates 
                                            },
                                            "notes": {
                                                "address": "Razorpay Corporate Office"
                                            },
                                            "theme": {
                                                "color": "#3399cc"
                                            }
									};
									const rzp1 = new Razorpay(options);
                                    rzp1.on('payment.failed', function (response) {
										console.error("Payment failed:", response);
										alert("Payment failed. Redirecting to orders page.");
										console.log("is it");


										// Call a backend endpoint to update the order status
										fetch('/failurePayment', {
											method: 'POST',
											headers: {
												'Content-Type': 'application/json',
											},
											body: JSON.stringify({ data }),
										}).then(() => {
											window.location.href = '/userorders'; // Redirect to the orders page
										}).catch(error => {
											console.error("Error updating order status:", error);
										});
									});
									rzp1.open();
                            })
                            }
                            else if (paymentMethod === 'wallet' && items.length != 0) {
    var totalElement = document.getElementById('totalAmountid');
    const totalamount = totalElement.textContent.trim();
    console.log('Processing wallet payment', totalamount);

    fetch('/walletpay', {
        method: 'post',
        headers: {
            'content-Type': 'application/json'
        },
        body: JSON.stringify({ totalamount, data, paymentMethod })
    }).then(res => res.json())
    .then(res => {
        console.log('Wallet payment response:', res);

        if (res.status === 401) {
            console.log('Error 401: Please add the Address to checkout');
            toastr.error('Please add the Address to checkout');
        }
        if (res.status === 400) {
            console.log('Error 400: Insufficient wallet balance');
            toastr.error('Insufficient wallet balance');
        }
        if (res.message === 'Order completed successfully') {
            console.log('Order completed');
            window.location.href = '/thankyou';
        }
    }).catch(error => {
        console.error('Fetch error:', error);
    });
}

                            else{
                                console.log('error');
                                
                            }


                    }
    })
})





    </script>
    
    <!-- <button id="rzp-button1">Pay</button> -->

    <script>

		document.addEventListener("DOMContentLoaded", function () {
			const applyButton = document.getElementById("applySelectedCoupon");
			const isCouponApplied = document.getElementById("isCouponApplied");

			applyButton.addEventListener("click", function () {
				console.log('isCouponApplied', isCouponApplied.value);
				if (isCouponApplied.value === 'false') {
					const selectedCoupon = document.querySelector('input[name="couponS"]:checked');
					var totalElement = document.getElementById('totalAmountid');
                                const totalAmount = totalElement.textContent.trim();

					console.log(selectedCoupon);
					
					if (selectedCoupon) {
						const couponCode = selectedCoupon.value;
						console.log(`Applying coupon: ${couponCode}`);

						// Send request to apply the selected coupon
						fetch('/applyCoupon', {
							method: "POST",
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({ couponCode,  totalAmount })
						})
							.then(response => response.json())
							.then(data => {
                               
								if (data.newTotalAmount !== undefined) {
									Swal.fire({
										title: "Success!",
										text:` Coupon has been applied. You saved ₹${data.discount}`,
										icon: "success",
									}).then(() => {
										document.getElementById('isCouponApplied').value = 'true';
										// Update the total amount on the page
                                        let newBalance =data.newTotalAmount
                                        let discount=data.discount
                                        
										document.getElementById("totalAmountid").value = data.newTotalAmount;
										document.getElementById("totalAmountid").innerHTML = data.newTotalAmount;
                                        document.getElementById("dicount-coupon").innerHTML=Math.round(data.discount)
                                        var totalElement = document.getElementById('totalAmountid');
                                        totalElement.textContent = newBalance;
                                        
            

									});
								} else {
									Swal.fire({
										title: "Failed!",
										text: data.message || "Failed to apply coupon.",
										icon: "error",
									});
								}
							})
							.catch(error => {
								console.error("Error:", error);
								Swal.fire({
									title: "Error!",
									text: "An error occurred while applying the coupon.",
									icon: "error",
								});
							});
					} else {
						Swal.fire({
							title: "Warning!",
							text: "Please select a coupon to apply.",
							icon: "warning",
						});
					}
				} else {
					Swal.fire({
						title: "Warning!",
						text: "Already Applied!",
						icon: "warning",
					});
				}

			});

		});



	</script>
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</body>

</html>